<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Backup Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-running {
            background: #3498db;
            color: white;
        }
        
        .status-idle {
            background: #27ae60;
            color: white;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: capitalize;
        }
        
        .nav-tab:hover {
            background: #f8f9fa;
        }
        
        .nav-tab.active {
            background: #3498db;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .backup-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .backup-list-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .backup-item {
            padding: 15px 20px;
            border-bottom: 1px solid #ecf0f1;
            display: grid;
            grid-template-columns: 1fr auto auto auto auto auto;
            gap: 15px;
            align-items: center;
        }
        
        .backup-actions {
            display: flex;
            gap: 8px;
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }
        
        .backup-item:hover {
            background: #f8f9fa;
        }
        
        .backup-timestamp {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .backup-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-running {
            background: #cce7ff;
            color: #004085;
        }
        
        .backup-duration {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .backup-size {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .backup-collections {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .view-logs-btn, .download-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        
        .view-logs-btn:hover, .download-btn:hover {
            background: #2980b9;
        }
        
        .view-logs-btn:disabled, .download-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .download-btn {
            background: #27ae60;
        }
        
        .download-btn:hover {
            background: #229954;
        }
        
        .current-backup {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .current-backup h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .current-backup-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .limit-selector {
            margin-left: auto;
        }
        
        .limit-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .log-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MongoDB Backup Dashboard</h1>
            <div id="system-status">
                <span class="status-indicator status-idle">System Idle</span>
            </div>
        </div>
        
        <div id="current-backup" class="current-backup" style="display: none;">
            <h3>Current Backup in Progress</h3>
            <div class="current-backup-info">
                <div>
                    <strong>Type:</strong> <span id="current-type"></span>
                </div>
                <div>
                    <strong>Started:</strong> <span id="current-start"></span>
                </div>
                <div>
                    <strong>Folder:</strong> <span id="current-folder"></span>
                </div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-type="daily">Daily</button>
            <button class="nav-tab" data-type="weekly">Weekly</button>
            <button class="nav-tab" data-type="monthly">Monthly</button>
            <button class="nav-tab" data-type="yearly">Yearly</button>
        </div>
        
        <div id="stats-container" class="stats-grid">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <div class="backup-list">
            <div class="backup-list-header">
                <h3>Recent Backups</h3>
                <div class="limit-selector">
                    <label for="limit-select">Show:</label>
                    <select id="limit-select">
                        <option value="5">5 backups</option>
                        <option value="10">10 backups</option>
                        <option value="15">15 backups</option>
                        <option value="20">20 backups</option>
                        <option value="30">30 backups</option>
                    </select>
                </div>
            </div>
            <div id="backup-list-content">
                <div class="loading">Loading backups...</div>
            </div>
        </div>
    </div>
    
    <!-- Log Modal -->
    <div id="log-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Backup Logs</h3>
                <span class="close">&times;</span>
            </div>
            <div id="log-content" class="log-content">
                Loading logs...
            </div>
        </div>
    </div>
    
    <script>
        let currentBackupType = 'daily';
        let currentLimit = 5;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadData();
            
            // Refresh data every 30 seconds
            setInterval(loadData, 30000);
        });
        
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentBackupType = this.dataset.type;
                    loadData();
                });
            });
            
            // Limit selector
            document.getElementById('limit-select').addEventListener('change', function() {
                currentLimit = parseInt(this.value);
                loadBackups();
            });
            
            // Modal close
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('log-modal').style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('log-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        async function loadData() {
            await Promise.all([
                loadCurrentStatus(),
                loadStats(),
                loadBackups()
            ]);
        }
        
        async function loadCurrentStatus() {
            try {
                const response = await fetch('/api/current');
                const data = await response.json();
                
                const statusElement = document.getElementById('system-status');
                const currentBackupElement = document.getElementById('current-backup');
                
                if (data.isRunning && data.currentBackup) {
                    statusElement.innerHTML = '<span class="status-indicator status-running">Backup Running</span>';
                    currentBackupElement.style.display = 'block';
                    
                    document.getElementById('current-type').textContent = data.currentBackup.type;
                    document.getElementById('current-start').textContent = new Date(data.currentBackup.startTime).toLocaleString();
                    document.getElementById('current-folder').textContent = data.currentBackup.folderName;
                } else {
                    statusElement.innerHTML = '<span class="status-indicator status-idle">System Idle</span>';
                    currentBackupElement.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading current status:', error);
            }
        }
        
        async function loadStats() {
            try {
                const response = await fetch(`/api/stats/${currentBackupType}`);
                const stats = await response.json();
                
                const statsContainer = document.getElementById('stats-container');
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_successful_backups}</div>
                        <div class="stat-label">Successful Backups</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_failed_backups}</div>
                        <div class="stat-label">Failed Backups</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.max_backups === -1 ? '∞' : stats.max_backups}</div>
                        <div class="stat-label">Max Backups</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_available_successful_backups}</div>
                        <div class="stat-label">Available Backups</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.average_duration_seconds}s</div>
                        <div class="stat-label">Avg Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_size_mb}MB</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-container').innerHTML = '<div class="error">Error loading statistics</div>';
            }
        }
        
        async function loadBackups() {
            try {
                const response = await fetch(`/api/backups/${currentBackupType}?limit=${currentLimit}`);
                const backups = await response.json();
                
                const listContent = document.getElementById('backup-list-content');
                
                if (backups.length === 0) {
                    listContent.innerHTML = '<div class="loading">No backups found</div>';
                    return;
                }
                
                listContent.innerHTML = backups.map(backup => `
                    <div class="backup-item">
                        <div class="backup-timestamp">${new Date(backup.timestamp).toLocaleString()}</div>
                        <div class="backup-status status-${backup.status}">${backup.status}</div>
                        <div class="backup-duration">${backup.duration_seconds}s</div>
                        <div class="backup-collections">${backup.collections_count} collections</div>
                        <div class="backup-size">${Math.round(backup.backup_size_bytes / 1024 / 1024)}MB</div>
                        <div class="backup-actions">
                            <button class="view-logs-btn" onclick="viewLogs(${backup.id})" ${backup.status === 'success' ? 'disabled' : ''}>
                                ${backup.status === 'failed' ? 'View Logs' : 'Logs'}
                            </button>
                            <button class="download-btn" onclick="downloadBackup(${backup.id})" ${backup.status !== 'success' ? 'disabled' : ''}>
                                Download
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading backups:', error);
                document.getElementById('backup-list-content').innerHTML = '<div class="error">Error loading backups</div>';
            }
        }
        
        async function viewLogs(backupId) {
            try {
                const response = await fetch(`/api/logs/${backupId}`);
                const data = await response.json();
                
                const modal = document.getElementById('log-modal');
                const logContent = document.getElementById('log-content');
                
                logContent.textContent = data.logs.join('\n');
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading logs:', error);
                alert('Error loading logs');
            }
        }
        
        async function downloadBackup(backupId) {
            try {
                const response = await fetch(`/api/download/${backupId}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Download failed: ${error.error}`);
                    return;
                }
                
                // Get filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                const filename = contentDisposition 
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `backup-${backupId}.tar.gz`;
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading backup:', error);
                alert('Error downloading backup');
            }
        }
    </script>
</body>
</html>
